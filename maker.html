<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revision Flashcards - Actiari</title>
    <link rel="icon" type="image/x-icon" href="./Miscellaneous/Main Favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --color-background: #f8f9fa;
            --color-surface: #ffffff;
            --color-border: #dee2e6;
            --color-text-primary: #212529;
            --color-text-secondary: #495057;
            --color-primary: #005fcc;
            --color-primary-hover: #004ca3;
            --radius-md: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* --- RESET & LAYOUT --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-family-sans);
            background-color: var(--color-background);
            color: var(--color-text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- HEADER (FIXED) --- */
        .site-header {
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            width: 100%; /* Ensures full width */
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .page-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            width: 100%;
        }

        /* Flex container for the header content */
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px; /* Fixed height for consistency */
        }

        .site-header__logo img { height: 32px; width: auto; display: block; }

        .site-header__nav ul { 
            list-style: none; 
            display: flex; 
            gap: 24px; 
            margin: 0; 
            padding: 0;
        }
        
        .site-header__nav a { 
            color: var(--color-text-secondary); 
            text-decoration: none; 
            font-weight: 500; 
            font-size: 0.95rem;
        }
        .site-header__nav a:hover, .site-header__nav a.active { color: var(--color-primary); }

        /* --- MAIN CONTENT --- */
        main {
            padding-top: 40px; /* Prevents collision with sticky header */
            padding-bottom: 60px;
        }

        .controls-container {
            background: var(--color-surface);
            padding: 32px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        label { font-size: 0.9rem; font-weight: 600; margin-bottom: 4px; display: block; color: var(--color-text-secondary); }
        select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; background-color: #fff; }
        
        .btn-primary { 
            background: var(--color-primary); color: white; 
            padding: 12px; border: none; border-radius: 6px; 
            font-weight: 600; cursor: pointer; width: 100%; font-size: 1rem;
        }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

        /* --- FLASHCARD GAME --- */
        #game-interface { display: none; max-width: 700px; margin: 0 auto; }
        .flashcard-scene { height: 400px; perspective: 1000px; margin-bottom: 24px; cursor: pointer; }
        .flashcard { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; border: 1px solid var(--color-border); border-radius: 16px; padding: 32px; text-align: center; }
        .flashcard-back { transform: rotateY(180deg); background-color: #f8f9fa; }
        
        .game-controls { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .nav-btn { background: white; border: 1px solid #ccc; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .nav-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="site-header">
        <div class="page-wrapper">
            <div class="header-content">
                <a href="index.html" class="site-header__logo">
                    <img src="Miscellaneous/Main Favicon.ico" alt="Actiari" width="32" height="32">
                </a>
                <nav class="site-header__nav">
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="geography.html" class="active">Flashcards</a></li>
                        <li><a href="maker.html">Create</a></li>
                        <li><a href="login.html">Account</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="page-wrapper">
        
        <!-- Title Section -->
        <div style="text-align: center; margin-bottom: 32px;">
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 8px;">Revision Flashcards</h1>
            <p style="color: var(--color-text-secondary);">Select a course below or view your custom packs.</p>
        </div>

        <!-- SELECTION INTERFACE -->
        <div id="setup-interface" class="controls-container">
            
            <!-- 1. COURSE PACK -->
            <div>
                <label for="course-select">1. Select Course Pack</label>
                <select id="course-select">
                    <option value="" disabled selected>Choose a Course...</option>
                    
                    <!-- === YOUR JSON FILES HERE === -->
                    <option value="geography-data.json">Geography (A Level)</option>
                    <option value="history-data.json">History</option>
                    <!-- ============================ -->

                </select>
            </div>

            <!-- 2. SUBJECT -->
            <div>
                <label for="subject-select">2. Module / Subject</label>
                <select id="subject-select" disabled>
                    <option value="" disabled selected>Select a Module...</option>
                </select>
            </div>

            <!-- 3. TOPIC -->
            <div>
                <label for="topic-select">3. Specific Topic</label>
                <select id="topic-select" disabled>
                    <option value="" disabled selected>Select a Topic...</option>
                </select>
            </div>

            <button id="start-btn" class="btn-primary" disabled>Start Practicing</button>
            
            <div id="custom-msg" style="display:none; text-align: center; font-size: 0.85rem; color: var(--color-primary); margin-top: -10px;">
                ● Loaded your custom decks
            </div>
        </div>

        <!-- GAME INTERFACE (Hidden Initially) -->
        <div id="game-interface">
            <div class="flashcard-scene" id="flashcard-scene">
                <div class="flashcard" id="flashcard">
                    <div class="flashcard-face flashcard-front">
                        <h3 style="font-size: 0.85rem; text-transform: uppercase; color: #999; margin-bottom: 16px;">Question</h3>
                        <div id="card-front-text" style="font-size: 1.35rem; font-weight: 500;">...</div>
                        <p style="margin-top: auto; font-size: 0.8rem; color: #aaa;">Click card to flip</p>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <h3 style="font-size: 0.85rem; text-transform: uppercase; color: #999; margin-bottom: 16px;">Answer</h3>
                        <div id="card-back-text" style="font-size: 1.35rem; font-weight: 500;">...</div>
                    </div>
                </div>
            </div>

            <div class="game-controls">
                <button id="prev-btn" class="nav-btn">Previous</button>
                <span id="progress-text" style="font-variant-numeric: tabular-nums; color: var(--color-text-secondary);">0 / 0</span>
                <button id="next-btn" class="btn-primary" style="width: auto; padding: 8px 24px;">Next</button>
            </div>

            <div style="text-align: center; margin-top: 32px;">
                <button id="quit-btn" style="background: none; border: none; color: var(--color-text-secondary); cursor: pointer; text-decoration: underline;">
                    ← Choose a different topic
                </button>
            </div>
        </div>
    </main>

<script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCCSMWeYi5PX5KVXSAakUMEFXMMd7ADWm4",
        authDomain: "actiari-w.firebaseapp.com",
        projectId: "actiari-w",
        storageBucket: "actiari-w.firebasestorage.app",
        messagingSenderId: "949681887722",
        appId: "1:949681887722:web:58680c5a6cdfadc5543a93",
        measurementId: "G-H250YE0QME"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- VARIABLES & ELEMENTS ---
    let activeData = {}; // Holds the currently selected data (JSON + Custom)
    let userCustomDecks = {}; // Holds just the custom decks from Database
    let currentDeck = [];
    let currentIndex = 0;

    const courseSelect = document.getElementById('course-select');
    const subjectSelect = document.getElementById('subject-select');
    const topicSelect = document.getElementById('topic-select');
    const startBtn = document.getElementById('start-btn');
    const flashcard = document.getElementById('flashcard');

    // --- 1. LOAD CUSTOM DECKS ON LOGIN ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const q = query(collection(db, "decks"), where("userId", "==", user.uid));
            const snap = await getDocs(q);
            
            if(!snap.empty) {
                document.getElementById('custom-msg').style.display = 'block';
                
                // Process user data
                snap.forEach(doc => {
                    const d = doc.data();
                    // Default to 'Custom Packs' if they didn't type a Subject
                    const sub = d.subject || "My Custom Packs";
                    
                    if(!userCustomDecks[sub]) userCustomDecks[sub] = {};
                    userCustomDecks[sub][d.title + " *"] = d.cards;
                });

                // Add a "Just my custom decks" option to the Course Dropdown
                const opt = document.createElement('option');
                opt.value = "CUSTOM_ONLY";
                opt.textContent = "My Custom Packs (Database)";
                opt.style.fontWeight = "bold";
                courseSelect.appendChild(opt);
            }
        }
    });

    // --- 2. COURSE SELECTION LOGIC ---
    courseSelect.addEventListener('change', async (e) => {
        const val = e.target.value;
        
        // Reset UI
        activeData = {};
        subjectSelect.innerHTML = '<option>Loading...</option>';
        topicSelect.innerHTML = '<option>Select Topic...</option>';
        topicSelect.disabled = true;
        startBtn.disabled = true;

        // Scenario A: They picked "My Custom Packs"
        if (val === "CUSTOM_ONLY") {
            activeData = { ...userCustomDecks };
            refreshSubjects();
            return;
        }

        // Scenario B: They picked a JSON file (Geography/History)
        try {
            const res = await fetch(val);
            if(res.ok) {
                const json = await res.json();
                // Merge: Course JSON + User Custom Decks
                // This ensures custom decks are ALWAYS visible even inside the Geo/History view
                activeData = { ...json, ...userCustomDecks };
                refreshSubjects();
            } else {
                // Fallback if file missing
                alert("Could not load file: " + val);
                activeData = { ...userCustomDecks };
                refreshSubjects();
            }
        } catch (err) {
            console.error(err);
        }
    });

    function refreshSubjects() {
        subjectSelect.innerHTML = '<option value="" disabled selected>Select a Module...</option>';
        subjectSelect.disabled = false;

        // Sort subjects alphabetically
        Object.keys(activeData).sort().forEach(subject => {
            const opt = document.createElement('option');
            opt.value = subject;
            opt.textContent = subject;
            subjectSelect.appendChild(opt);
        });
    }

    // --- 3. DROPDOWN LOGIC ---
    subjectSelect.addEventListener('change', (e) => {
        const sub = e.target.value;
        topicSelect.innerHTML = '<option value="" disabled selected>Select a Topic...</option>';
        topicSelect.disabled = false;
        
        if(activeData[sub]) {
            Object.keys(activeData[sub]).forEach(topic => {
                const opt = document.createElement('option');
                opt.value = topic;
                opt.textContent = topic;
                topicSelect.appendChild(opt);
            });
        }
        startBtn.disabled = true;
    });

    topicSelect.addEventListener('change', () => startBtn.disabled = false);

    // --- 4. GAME LOGIC ---
    startBtn.addEventListener('click', () => {
        currentDeck = activeData[subjectSelect.value][topicSelect.value];
        currentIndex = 0;
        loadCard(0);
        
        // Switch Views
        document.getElementById('setup-interface').style.display = 'none';
        document.getElementById('game-interface').style.display = 'block';
        // Hide title/dropdowns to focus on game
        document.querySelector('main h1').style.display = 'none'; 
        document.querySelector('main p').style.display = 'none'; 
    });

    document.getElementById('quit-btn').addEventListener('click', () => {
        // Reset Views
        document.getElementById('setup-interface').style.display = 'flex';
        document.getElementById('game-interface').style.display = 'none';
        document.querySelector('main h1').style.display = 'block';
        document.querySelector('main p').style.display = 'block';
        flashcard.classList.remove('is-flipped');
    });

    function loadCard(i) {
        flashcard.classList.remove('is-flipped');
        // Small delay to allow flip animation to reset if needed
        setTimeout(() => {
            document.getElementById('card-front-text').textContent = currentDeck[i].q;
            document.getElementById('card-back-text').textContent = currentDeck[i].a;
            document.getElementById('progress-text').textContent = `${i+1} / ${currentDeck.length}`;
            
            document.getElementById('prev-btn').disabled = (i === 0);
            document.getElementById('next-btn').disabled = (i === currentDeck.length - 1);
        }, 200);
    }

    // Interactions
    document.getElementById('flashcard-scene').addEventListener('click', () => flashcard.classList.toggle('is-flipped'));
    document.getElementById('next-btn').addEventListener('click', (e) => { 
        e.stopPropagation(); 
        if(currentIndex < currentDeck.length-1) loadCard(++currentIndex); 
    });
    document.getElementById('prev-btn').addEventListener('click', (e) => { 
        e.stopPropagation(); 
        if(currentIndex > 0) loadCard(--currentIndex); 
    });

</script>
</body>
</html>