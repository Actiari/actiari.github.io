<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revision Flashcards - Actiari</title>
    <link rel="icon" type="image/x-icon" href="./Miscellaneous/Main Favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CSS REMAINED THE SAME (Hidden for brevity) -->
    <style>
        :root { --font-family-sans: 'Inter', sans-serif; --color-primary: #005fcc; --radius-md: 8px; }
        body { font-family: var(--font-family-sans); background: #f8f9fa; color: #212529; margin: 0; padding: 0; display:flex; flex-direction:column; min-height:100vh;}
        .page-wrapper { max-width: 1000px; margin: 0 auto; padding: 20px; width: 100%; }
        .controls-container { background: white; padding: 24px; border-radius: 8px; border: 1px solid #dee2e6; max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px;}
        select, button { padding: 10px; width: 100%; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }
        button { background: var(--color-primary); color: white; font-weight: 600; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        /* Flashcard Styles */
        #game-interface { display: none; max-width: 700px; margin: 0 auto; }
        .flashcard-scene { height: 400px; perspective: 1000px; margin-bottom: 20px; cursor: pointer; }
        .flashcard { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 16px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; border: 1px solid #eee; border-radius: 16px; padding: 20px; text-align: center; }
        .flashcard-back { transform: rotateY(180deg); background: #f8f9fa; }
        .nav-btn { background: transparent; border: 1px solid #ccc; color: #333; width: auto; padding: 10px 20px; }
    </style>
</head>
<body>

    <header class="site-header" style="background:white; border-bottom:1px solid #eee; padding:12px 0;">
        <div class="page-wrapper" style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
            <a href="index.html" class="site-header__logo" aria-label="Actiari Home">
                <img src="Miscellaneous/Main Favicon.ico" alt="Actiari Logo" width="32" height="32">
            </a>
            <nav class="site-header__nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="APR.html">Past Papers</a></li>
                    <li><a href="FLASH.html" aria-current="page">Flashcards</a></li>
                    <li><a href="login.html">Login</a></li>
                    <li><a href="maker.html">Create Deck</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="page-wrapper">
        <h1 style="text-align:center; margin: 40px 0 10px;">Revision Flashcards</h1>
        <p style="text-align:center; color:#666; margin-bottom:30px;">Select a course pack below.</p>

        <!-- SETUP INTERFACE -->
        <div id="setup-interface" class="controls-container">
            
            <!-- 1. COURSE SELECTOR -->
            <div>
                <label><strong>1. Select Course Pack</strong></label>
                <select id="course-select">
                    <option value="" disabled selected>Choose a Course...</option>
                    <!-- YOU REGISTER YOUR FILES HERE -->
                    <option value="geography-data.json">Geography (A Level)</option>
                    <option value="history-data.json">History (Cold War)</option>
                    <!-- Add more options here as you upload more files -->
                </select>
            </div>

            <!-- 2. SUBJECT SELECTOR -->
            <div>
                <label><strong>2. Module / Subject</strong></label>
                <select id="subject-select" disabled>
                    <option value="" disabled selected>Select a Module...</option>
                </select>
            </div>

            <!-- 3. TOPIC SELECTOR -->
            <div>
                <label><strong>3. Specific Topic</strong></label>
                <select id="topic-select" disabled>
                    <option value="" disabled selected>Select a Topic...</option>
                </select>
            </div>

            <button id="start-btn" disabled>Start Practicing</button>
            <div id="custom-msg" style="text-align:center; font-size:0.8rem; color:green; display:none; margin-top:5px;">
                + Custom decks loaded from database
            </div>
        </div>

        <!-- GAME INTERFACE -->
        <div id="game-interface">
            <div class="flashcard-scene" id="flashcard-scene">
                <div class="flashcard" id="flashcard">
                    <div class="flashcard-face flashcard-front">
                        <h3 style="font-size:0.9rem; color:#999;">QUESTION</h3>
                        <div id="card-front-text" style="font-size:1.4rem; font-weight:500;">...</div>
                        <p style="margin-top:auto; font-size:0.8rem; color:#999;">Click to flip</p>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <h3 style="font-size:0.9rem; color:#999;">ANSWER</h3>
                        <div id="card-back-text" style="font-size:1.4rem; font-weight:500;">...</div>
                    </div>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button id="prev-btn" class="nav-btn">Previous</button>
                <span id="progress-text">0 / 0</span>
                <button id="next-btn" class="nav-btn" style="background:#005fcc; color:white; border:none;">Next</button>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <a href="#" id="quit-btn" style="color:#666;">‚Üê Select different topic</a>
            </div>
        </div>
    </main>

<script type="module">
    // FIREBASE IMPORTS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCCSMWeYi5PX5KVXSAakUMEFXMMd7ADWm4",
        authDomain: "actiari-w.firebaseapp.com",
        projectId: "actiari-w",
        storageBucket: "actiari-w.firebasestorage.app",
        messagingSenderId: "949681887722",
        appId: "1:949681887722:web:58680c5a6cdfadc5543a93",
        measurementId: "G-H250YE0QME"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // VARIABLES
    let activeData = {}; 
    let userCustomDecks = {}; // Store custom decks separately
    let currentDeck = [];
    let currentIndex = 0;

    // ELEMENTS
    const courseSelect = document.getElementById('course-select');
    const subjectSelect = document.getElementById('subject-select');
    const topicSelect = document.getElementById('topic-select');
    const startBtn = document.getElementById('start-btn');
    const flashcard = document.getElementById('flashcard');

    // 1. LOAD USER CUSTOM DECKS (Always fetch these in background)
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const q = query(collection(db, "decks"), where("userId", "==", user.uid));
            const snap = await getDocs(q);
            if(!snap.empty) {
                document.getElementById('custom-msg').style.display = 'block';
                snap.forEach(doc => {
                    const d = doc.data();
                    // Store simply: Subject -> Topic -> Cards
                    const sub = d.subject || "My Custom Packs";
                    if(!userCustomDecks[sub]) userCustomDecks[sub] = {};
                    userCustomDecks[sub][d.title + " (Custom)"] = d.cards;
                });
                // If a course is already selected, refresh the dropdowns
                if(courseSelect.value) refreshSubjects(); 
            }
        }
    });

    // 2. HANDLE COURSE SELECTION (Load the specific JSON file)
    courseSelect.addEventListener('change', async (e) => {
        const file = e.target.value;
        
        // Reset Data
        activeData = {};
        subjectSelect.innerHTML = '<option>Loading...</option>';
        topicSelect.innerHTML = '<option>Select Topic...</option>';
        topicSelect.disabled = true;

        try {
            const res = await fetch(file);
            if(res.ok) {
                const json = await res.json();
                // Merge JSON data + User Custom Data
                activeData = { ...json, ...userCustomDecks };
                refreshSubjects();
            } else {
                alert("Could not load that file.");
            }
        } catch (err) {
            console.error(err);
            // Even if file fails, show custom decks
            activeData = { ...userCustomDecks };
            refreshSubjects();
        }
    });

    function refreshSubjects() {
        subjectSelect.innerHTML = '<option value="" disabled selected>Select a Module...</option>';
        subjectSelect.disabled = false;

        Object.keys(activeData).sort().forEach(subject => {
            const opt = document.createElement('option');
            opt.value = subject;
            opt.textContent = subject;
            subjectSelect.appendChild(opt);
        });
    }

    // 3. STANDARD UI LOGIC (Same as before)
    subjectSelect.addEventListener('change', (e) => {
        const sub = e.target.value;
        topicSelect.innerHTML = '<option value="" disabled selected>Select a Topic...</option>';
        topicSelect.disabled = false;
        
        if(activeData[sub]) {
            Object.keys(activeData[sub]).forEach(topic => {
                const opt = document.createElement('option');
                opt.value = topic;
                opt.textContent = topic;
                topicSelect.appendChild(opt);
            });
        }
        startBtn.disabled = true;
    });

    topicSelect.addEventListener('change', () => startBtn.disabled = false);

    startBtn.addEventListener('click', () => {
        currentDeck = activeData[subjectSelect.value][topicSelect.value];
        currentIndex = 0;
        loadCard(0);
        document.getElementById('setup-interface').style.display = 'none';
        document.getElementById('game-interface').style.display = 'block';
    });

    document.getElementById('quit-btn').addEventListener('click', () => {
        document.getElementById('setup-interface').style.display = 'flex';
        document.getElementById('game-interface').style.display = 'none';
        flashcard.classList.remove('is-flipped');
    });

    function loadCard(i) {
        flashcard.classList.remove('is-flipped');
        setTimeout(() => {
            document.getElementById('card-front-text').textContent = currentDeck[i].q;
            document.getElementById('card-back-text').textContent = currentDeck[i].a;
            document.getElementById('progress-text').textContent = `${i+1} / ${currentDeck.length}`;
            document.getElementById('prev-btn').disabled = (i === 0);
            document.getElementById('next-btn').disabled = (i === currentDeck.length - 1);
        }, 200);
    }

    document.getElementById('flashcard-scene').addEventListener('click', () => flashcard.classList.toggle('is-flipped'));
    document.getElementById('next-btn').addEventListener('click', (e) => { e.stopPropagation(); if(currentIndex < currentDeck.length-1) loadCard(++currentIndex); });
    document.getElementById('prev-btn').addEventListener('click', (e) => { e.stopPropagation(); if(currentIndex > 0) loadCard(--currentIndex); });

</script>
</body>
</html>