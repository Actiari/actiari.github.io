<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geography Flashcards - Actiari</title>
    <meta name="description" content="Practice A Level and BTEC Geography flashcards. Interactive revision tool.">
    <link rel="icon" type="image/x-icon" href="./Miscellaneous/Main Favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS (Same as before) --- */
        :root {
            --font-family-sans: 'Inter', sans-serif;
            --radius-md: 8px; --radius-lg: 16px;
            --color-background: #f8f9fa; --color-surface: #ffffff;
            --color-border: #dee2e6; --color-text-primary: #212529;
            --color-primary: #005fcc; --color-text-secondary: #495057;
        }
        .dark-mode {
            --color-background: #121212; --color-surface: #1e1e1e;
            --color-border: #333; --color-text-primary: #e0e0e0;
            --color-primary: #4dabf7; --color-text-secondary: #b0b0b0;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family-sans); background-color: var(--color-background); color: var(--color-text-primary); line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; }
        a { color: var(--color-primary); text-decoration: none; }
        .page-wrapper { max-width: 1400px; margin: 0 auto; padding: 0 24px; width: 100%; }
        
        .site-header { padding: 16px 0; background-color: var(--color-surface); border-bottom: 1px solid var(--color-border); }
        .site-header .page-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .site-header__nav ul { list-style: none; display: flex; gap: 24px; }
        
        .controls-container { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; background-color: var(--color-surface); padding: 24px; border-radius: var(--radius-md); border: 1px solid var(--color-border); }
        .form-select { padding: 10px; width: 100%; border-radius: var(--radius-md); border: 1px solid var(--color-border); background: var(--color-background); color: var(--color-text-primary); }
        
        .btn { padding: 12px 24px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; border: none; width: 100%; transition: 0.2s; }
        .btn-primary { background-color: var(--color-primary); color: #fff; }
        .btn-outline { background-color: transparent; border: 1px solid var(--color-border); color: var(--color-text-secondary); }
        
        #game-interface { display: none; max-width: 700px; margin: 0 auto; }
        .flashcard-scene { width: 100%; height: 400px; perspective: 1000px; margin-bottom: 24px; cursor: pointer; }
        .flashcard { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; border-radius: var(--radius-lg); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px; text-align: center; background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); }
        .flashcard-back { transform: rotateY(180deg); background-color: var(--color-background); }
        .game-controls { display: flex; justify-content: space-between; align-items: center; }
        .site-footer { margin-top: 64px; padding: 32px 0; background-color: var(--color-surface); border-top: 1px solid var(--color-border); text-align: center; }
    </style>
</head>
<body>

    <header class="site-header">
        <div class="page-wrapper">
            <a href="index.html" style="font-weight: 700; font-size: 1.2rem; color: var(--color-text-primary);">Actiari</a>
            <nav class="site-header__nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="geography.html" style="color: var(--color-primary);">Flashcards</a></li>
                    <li><a href="maker.html">Create Deck</a></li>
                    <li><a href="login.html">Account</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="page-wrapper">
        <div class="page-title" style="text-align: center; margin: 48px 0 32px;">
            <h1>Geography Flashcards</h1>
            <p id="welcome-text">Select a topic below to start.</p>
        </div>

        <!-- SETUP INTERFACE -->
        <div id="setup-interface" class="controls-container">
            <div>
                <label style="font-size: 0.9rem; font-weight: 600;">Subject Module</label>
                <select id="subject-select" class="form-select">
                    <option value="" disabled selected>Loading data...</option>
                </select>
            </div>

            <div>
                <label style="font-size: 0.9rem; font-weight: 600;">Specific Topic</label>
                <select id="topic-select" class="form-select" disabled>
                    <option value="" disabled selected>Select a Topic...</option>
                </select>
            </div>

            <button id="start-btn" class="btn btn-primary" disabled>Start Practicing</button>
            
            <div id="custom-deck-msg" style="font-size: 0.85rem; color: var(--color-text-secondary); text-align: center; display: none;">
                Logged in: Your custom decks are available in the dropdown.
            </div>
        </div>

        <!-- GAME INTERFACE -->
        <div id="game-interface">
            <div class="flashcard-scene" id="flashcard-scene">
                <div class="flashcard" id="flashcard">
                    <!-- Front -->
                    <div class="flashcard-face flashcard-front">
                        <h3 style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 15px;">QUESTION</h3>
                        <div style="font-size: 1.5rem; font-weight: 500;" id="card-front-text">...</div>
                        <p style="font-size: 0.8rem; margin-top: auto; color: var(--color-text-secondary);">Click to flip</p>
                    </div>
                    <!-- Back -->
                    <div class="flashcard-face flashcard-back">
                        <h3 style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 15px;">ANSWER</h3>
                        <div style="font-size: 1.5rem; font-weight: 500;" id="card-back-text">...</div>
                    </div>
                </div>
            </div>

            <div class="game-controls">
                <button id="prev-btn" class="btn btn-outline" style="width: auto;">Previous</button>
                <div id="progress-text">Card 1 of 10</div>
                <button id="next-btn" class="btn btn-primary" style="width: auto;">Next</button>
            </div>
            <div style="text-align: center; margin-top: 20px; cursor: pointer;" id="quit-btn">‚Üê Select another topic</div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="page-wrapper">
            <p>&copy; 2025 Actiari Study Tools.</p>
        </div>
    </footer>

    <!-- LOGIC -->
    <script type="module">
        // 1. Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCSMWeYi5PX5KVXSAakUMEFXMMd7ADWm4",
            authDomain: "actiari-w.firebaseapp.com",
            projectId: "actiari-w",
            storageBucket: "actiari-w.firebasestorage.app",
            messagingSenderId: "949681887722",
            appId: "1:949681887722:web:58680c5a6cdfadc5543a93",
            measurementId: "G-H250YE0QME"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 3. Variables & Elements
        let combinedData = {}; 
        let currentDeck = [];
        let currentIndex = 0;

        const subjectSelect = document.getElementById('subject-select');
        const topicSelect = document.getElementById('topic-select');
        const startBtn = document.getElementById('start-btn');
        const flashcard = document.getElementById('flashcard');
        
        // 4. Initialize Data Loading
        async function initApp() {
            // A. Load Standard JSON
            try {
                const response = await fetch('geography-data.json');
                if(response.ok) {
                    const jsonData = await response.json();
                    combinedData = { ...jsonData }; // Start with JSON data
                }
            } catch (e) { console.error("No JSON file found"); }

            // B. Check Login & Load Custom Decks
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    document.getElementById('custom-deck-msg').style.display = 'block';
                    await loadCustomDecks(user.uid);
                }
                // C. Finally, Populate Dropdown
                populateSubjects();
            });
        }

        // 5. Fetch Custom Decks from Firestore
        async function loadCustomDecks(userId) {
            const q = query(collection(db, "decks"), where("userId", "==", userId));
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
                // Create a new category called "My Custom Decks"
                combinedData["My Custom Decks"] = {};
                
                querySnapshot.forEach((doc) => {
                    const deck = doc.data();
                    // Add each deck as a "Topic" under the Custom category
                    combinedData["My Custom Decks"][deck.title] = deck.cards;
                });
            }
        }

        // 6. Populate UI
        function populateSubjects() {
            subjectSelect.innerHTML = '<option value="" disabled selected>Select a Module...</option>';
            
            Object.keys(combinedData).forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
        }

        // 7. Event Listeners
        subjectSelect.addEventListener('change', (e) => {
            const subject = e.target.value;
            topicSelect.innerHTML = '<option value="" disabled selected>Select a Topic...</option>';
            topicSelect.disabled = false;
            
            if (combinedData[subject]) {
                Object.keys(combinedData[subject]).forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic;
                    option.textContent = topic;
                    topicSelect.appendChild(option);
                });
            }
            startBtn.disabled = true;
        });

        topicSelect.addEventListener('change', () => { startBtn.disabled = false; });

        startBtn.addEventListener('click', () => {
            const subject = subjectSelect.value;
            const topic = topicSelect.value;
            
            currentDeck = combinedData[subject][topic];
            currentIndex = 0;
            loadCard(currentIndex);
            
            document.getElementById('setup-interface').style.display = 'none';
            document.getElementById('game-interface').style.display = 'block';
            document.querySelector('.page-title h1').textContent = topic;
        });

        document.getElementById('quit-btn').addEventListener('click', () => {
            document.getElementById('setup-interface').style.display = 'flex';
            document.getElementById('game-interface').style.display = 'none';
            document.querySelector('.page-title h1').textContent = "Geography Flashcards";
            flashcard.classList.remove('is-flipped');
        });

        // Game Logic
        function loadCard(index) {
            flashcard.classList.remove('is-flipped');
            setTimeout(() => {
                document.getElementById('card-front-text').textContent = currentDeck[index].q;
                document.getElementById('card-back-text').textContent = currentDeck[index].a;
                document.getElementById('progress-text').textContent = `Card ${index + 1} of ${currentDeck.length}`;
                
                document.getElementById('prev-btn').disabled = index === 0;
                document.getElementById('next-btn').disabled = index === currentDeck.length - 1;
            }, 200);
        }

        document.getElementById('flashcard-scene').addEventListener('click', () => flashcard.classList.toggle('is-flipped'));
        
        document.getElementById('next-btn').addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent flip when clicking button
            if (currentIndex < currentDeck.length - 1) { currentIndex++; loadCard(currentIndex); }
        });

        document.getElementById('prev-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentIndex > 0) { currentIndex--; loadCard(currentIndex); }
        });

        // Start the app
        initApp();

        // Dark Mode (Optional)
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    </script>
</body>
</html>