<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revision Flashcards - Actiari</title>
    <link rel="icon" type="image/x-icon" href="./Miscellaneous/Main Favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family-sans: 'Inter', sans-serif;
            --color-background: #0b0f12;
            --color-surface: #121316;
            --color-surface-hover: #1a1d20;
            --color-border: #222426;
            --color-text-primary: #e6eef8;
            --color-text-secondary: #b8c2cc;
            --color-primary: #4dabf7; /* Blue */
            --radius-md: 8px;
        }

        /* --- RESET & LAYOUT --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: var(--font-family-sans); 
            background: var(--color-background); 
            color: var(--color-text-primary); 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
        }

        .page-wrapper { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 0 24px; 
            width: 100%; 
        }

        /* --- HEADER (FIXED) --- */
        .site-header { 
            background: #000000; 
            border-bottom: 1px solid #222426; 
            padding: 16px 0;
            width: 100%;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .site-header__logo img { display: block; }

        .site-header__nav ul { list-style: none; display: flex; gap: 24px; }
        .site-header__nav a { color: #4dabf7; font-weight: 600; text-decoration: none; transition: 0.2s; }
        .site-header__nav a:hover { color: #a5d8ff; text-decoration: underline; }

        /* --- MAIN CONTROLS --- */
        main { padding-top: 40px; padding-bottom: 60px; }

        .controls-container { 
            background: var(--color-surface); 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid var(--color-border); 
            max-width: 600px; 
            margin: 0 auto; 
            display: flex; 
            flex-direction: column; 
            gap: 20px;
        }

        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--color-text-secondary); }

        /* --- DROPDOWN STYLING (FIXED VISIBILITY) --- */
        select { 
            padding: 12px; 
            width: 100%; 
            border-radius: 8px; 
            border: 1px solid var(--color-border); 
            font-size: 1rem; 
            background: var(--color-surface); 
            color: var(--color-text-primary);
            cursor: pointer;
        }

        /* THE FIX: Black background, Blue text for options */
        select option {
            background-color: #000000;
            color: #4dabf7;
            padding: 10px;
        }

        button { 
            padding: 12px; 
            width: 100%; 
            border-radius: 8px; 
            font-size: 1rem; 
            background: var(--color-primary); 
            color: #000; /* Dark text on blue button for contrast */
            font-weight: 700; 
            cursor: pointer; 
            border: none; 
        }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }

        /* --- FLASHCARD SCENE --- */
        #game-interface { display: none; max-width: 700px; margin: 0 auto; }
        .flashcard-scene { height: 400px; perspective: 1000px; margin-bottom: 24px; cursor: pointer; }
        .flashcard { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; box-shadow: 0 8px 20px rgba(0,0,0,0.5); border-radius: 16px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        
        .flashcard-face { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: var(--color-surface); border: 1px solid var(--color-border); 
            border-radius: 16px; padding: 30px; text-align: center; color: var(--color-text-primary); 
        }
        
        .flashcard-back { transform: rotateY(180deg); background: var(--color-surface-hover); }
        
        .nav-btn { background: transparent; border: 1px solid var(--color-border); color: var(--color-text-primary); width: auto; padding: 8px 24px; }
        .nav-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }

        /* Mobile Responsive Header */
        @media (max-width: 600px) {
            .site-header__nav ul { gap: 12px; font-size: 0.8rem; }
            .page-wrapper { padding: 0 16px; }
        }
    </style>
</head>
<body>

    <header class="site-header">
        <div class="page-wrapper header-inner">
            <a href="index.html" class="site-header__logo" aria-label="Actiari Home">
                <img src="Miscellaneous/Main Favicon.ico" alt="Actiari" width="32" height="32">
            </a>
            <nav class="site-header__nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="APR.html">Past Papers</a></li>
                    <li><a href="FLASH.html">Flashcards</a></li>
                    <li><a href="maker.html">Create Deck</a></li>
                    <li><a href="login.html">Login</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="page-wrapper">
        <h1 style="text-align:center; margin: 30px 0 10px; font-size: 2rem;">Revision Flashcards</h1>
        <p style="text-align:center; color:var(--color-text-secondary); margin-bottom:40px;">Select a course pack below to begin.</p>

        <!-- SETUP INTERFACE -->
        <div id="setup-interface" class="controls-container">
            
            <!-- 1. COURSE SELECTOR -->
            <div>
                <label for="course-select">1. Select Course Pack</label>
                <select id="course-select">
                    <option value="" disabled selected>Choose a Course...</option>
                    
                    <!-- OPTION A: USER CUSTOM DECKS -->
                    <option value="CUSTOM" style="font-weight: bold;">★ My Custom Decks (Database)</option>
                    
                    <!-- OPTION B: PREMADE JSON FILES -->
                    <option value="geography-data.json">Geography (A Level)</option>
                    <option value="history-data.json">History</option>
                </select>
            </div>

            <!-- 2. SUBJECT SELECTOR -->
            <div>
                <label for="subject-select">2. Module / Subject</label>
                <select id="subject-select" disabled>
                    <option value="" disabled selected>Select a Module...</option>
                </select>
            </div>

            <!-- 3. TOPIC SELECTOR -->
            <div>
                <label for="topic-select">3. Specific Topic</label>
                <select id="topic-select" disabled>
                    <option value="" disabled selected>Select a Topic...</option>
                </select>
            </div>

            <button id="start-btn" disabled>Start Practicing</button>
            
            <div id="status-msg" style="text-align:center; font-size:0.85rem; color:var(--color-text-secondary); display:none; margin-top:5px;">
                Loading...
            </div>
        </div>

        <!-- GAME INTERFACE -->
        <div id="game-interface">
            <div class="flashcard-scene" id="flashcard-scene">
                <div class="flashcard" id="flashcard">
                    <div class="flashcard-face flashcard-front">
                        <h3 style="font-size:0.8rem; text-transform: uppercase; color:var(--color-text-secondary); margin-bottom: 16px;">Question</h3>
                        <div id="card-front-text" style="font-size:1.5rem; font-weight:500;">...</div>
                        <p style="margin-top:auto; font-size:0.8rem; color:var(--color-text-secondary);">Tap to flip</p>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <h3 style="font-size:0.8rem; text-transform: uppercase; color:var(--color-text-secondary); margin-bottom: 16px;">Answer</h3>
                        <div id="card-back-text" style="font-size:1.5rem; font-weight:500;">...</div>
                    </div>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button id="prev-btn" class="nav-btn">Previous</button>
                <span id="progress-text" style="color: var(--color-text-secondary);">0 / 0</span>
                <button id="next-btn" class="nav-btn" style="background:var(--color-primary); color:black; border:none;">Next</button>
            </div>
            <div style="text-align:center; margin-top:32px;">
                <button id="quit-btn" style="background:none; border:none; color:var(--color-text-secondary); text-decoration: underline; font-weight: 400;">
                    ← Select different topic
                </button>
            </div>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCCSMWeYi5PX5KVXSAakUMEFXMMd7ADWm4",
        authDomain: "actiari-w.firebaseapp.com",
        projectId: "actiari-w",
        storageBucket: "actiari-w.firebasestorage.app",
        messagingSenderId: "949681887722",
        appId: "1:949681887722:web:58680c5a6cdfadc5543a93",
        measurementId: "G-H250YE0QME"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- VARIABLES ---
    let activeData = {}; // Data currently available in dropdowns
    let userCustomDecks = {}; // Stored custom decks
    let currentDeck = [];
    let currentIndex = 0;

    // --- ELEMENTS ---
    const courseSelect = document.getElementById('course-select');
    const subjectSelect = document.getElementById('subject-select');
    const topicSelect = document.getElementById('topic-select');
    const startBtn = document.getElementById('start-btn');
    const statusMsg = document.getElementById('status-msg');
    const flashcard = document.getElementById('flashcard');

    // --- 1. LOAD DATABASE (CUSTOM DECKS) ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            statusMsg.style.display = 'block';
            statusMsg.style.color = '#4dabf7';
            statusMsg.textContent = "Checking for custom decks...";
            
            try {
                const q = query(collection(db, "decks"), where("userId", "==", user.uid));
                const snap = await getDocs(q);
                
                if(!snap.empty) {
                    userCustomDecks = {}; // Clear old
                    snap.forEach(doc => {
                        const d = doc.data();
                        // Structure: Subject -> Topic -> Cards
                        const sub = d.subject || "My Custom Packs";
                        if(!userCustomDecks[sub]) userCustomDecks[sub] = {};
                        userCustomDecks[sub][d.title] = d.cards;
                    });
                    
                    statusMsg.textContent = "✓ Custom decks loaded.";
                    
                    // If user already selected "CUSTOM", refresh the view immediately
                    if(courseSelect.value === "CUSTOM") {
                        activeData = { ...userCustomDecks };
                        refreshSubjects();
                    }
                } else {
                    statusMsg.textContent = "No custom decks found.";
                }
            } catch (e) {
                console.error(e);
                statusMsg.style.color = "red";
                statusMsg.textContent = "Error loading custom decks.";
            }
        } else {
            statusMsg.style.display = 'block';
            statusMsg.textContent = "Log in to see custom decks.";
        }
    });

    // --- 2. COURSE SELECTION HANDLER ---
    courseSelect.addEventListener('change', async (e) => {
        const val = e.target.value;
        
        // Reset UI
        activeData = {};
        subjectSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
        topicSelect.innerHTML = '<option value="" disabled selected>Select Topic...</option>';
        subjectSelect.disabled = true;
        topicSelect.disabled = true;
        startBtn.disabled = true;

        // A. User picked Custom Decks
        if (val === "CUSTOM") {
            if (Object.keys(userCustomDecks).length === 0) {
                alert("No custom decks found. Please create one in the 'Create Deck' page or wait for login.");
                subjectSelect.innerHTML = '<option value="" disabled selected>No decks found</option>';
                return;
            }
            activeData = { ...userCustomDecks };
            refreshSubjects();
            return;
        }

        // B. User picked a JSON file
        try {
            const res = await fetch(val);
            if(!res.ok) throw new Error("File not found");
            
            const json = await res.json();
            activeData = json; // Load just the JSON data
            refreshSubjects();
            
        } catch (err) {
            console.error(err);
            alert("Could not load course file. Make sure '" + val + "' exists in your folder.");
            subjectSelect.innerHTML = '<option value="" disabled selected>Error loading file</option>';
        }
    });

    // Helper to fill Subject Dropdown
    function refreshSubjects() {
        subjectSelect.innerHTML = '<option value="" disabled selected>Select a Module...</option>';
        subjectSelect.disabled = false;

        const subjects = Object.keys(activeData).sort();
        subjects.forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub;
            opt.textContent = sub;
            subjectSelect.appendChild(opt);
        });
    }

    // --- 3. SUBJECT SELECTION ---
    subjectSelect.addEventListener('change', (e) => {
        const sub = e.target.value;
        topicSelect.innerHTML = '<option value="" disabled selected>Select a Topic...</option>';
        topicSelect.disabled = false;
        startBtn.disabled = true;

        if(activeData[sub]) {
            const topics = Object.keys(activeData[sub]).sort();
            topics.forEach(topic => {
                const opt = document.createElement('option');
                opt.value = topic;
                opt.textContent = topic;
                topicSelect.appendChild(opt);
            });
        }
    });

    // --- 4. TOPIC SELECTION ---
    topicSelect.addEventListener('change', () => {
        startBtn.disabled = false;
    });

    // --- 5. START GAME ---
    startBtn.addEventListener('click', () => {
        const sub = subjectSelect.value;
        const top = topicSelect.value;
        
        if(activeData[sub] && activeData[sub][top]) {
            currentDeck = activeData[sub][top];
            currentIndex = 0;
            loadCard(0);
            
            document.getElementById('setup-interface').style.display = 'none';
            document.getElementById('game-interface').style.display = 'block';
            document.querySelector('h1').style.display = 'none';
            document.querySelector('p').style.display = 'none';
        }
    });

    // --- 6. GAME CONTROLS ---
    document.getElementById('quit-btn').addEventListener('click', () => {
        document.getElementById('setup-interface').style.display = 'flex';
        document.getElementById('game-interface').style.display = 'none';
        document.querySelector('h1').style.display = 'block';
        document.querySelector('p').style.display = 'block';
        flashcard.classList.remove('is-flipped');
    });

    function loadCard(i) {
        flashcard.classList.remove('is-flipped');
        setTimeout(() => {
            const card = currentDeck[i];
            document.getElementById('card-front-text').textContent = card.q;
            document.getElementById('card-back-text').textContent = card.a;
            document.getElementById('progress-text').textContent = `${i+1} / ${currentDeck.length}`;
            
            document.getElementById('prev-btn').disabled = (i === 0);
            document.getElementById('next-btn').disabled = (i === currentDeck.length - 1);
        }, 200);
    }

    document.getElementById('flashcard-scene').addEventListener('click', () => flashcard.classList.toggle('is-flipped'));
    document.getElementById('next-btn').addEventListener('click', (e) => { e.stopPropagation(); if(currentIndex < currentDeck.length-1) loadCard(++currentIndex); });
    document.getElementById('prev-btn').addEventListener('click', (e) => { e.stopPropagation(); if(currentIndex > 0) loadCard(--currentIndex); });

</script>
</body>
</html>